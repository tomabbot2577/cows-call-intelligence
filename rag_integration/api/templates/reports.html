{% extends "base.html" %}

{% block title %}Reports{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-file-earmark-bar-graph me-2"></i>Reports</h2>
</div>

<div class="row">
    <!-- Churn Risk Report -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-danger text-white">
                <i class="bi bi-exclamation-triangle me-2"></i>Churn Risk Report
            </div>
            <div class="card-body">
                <p>Identify customers at high risk of churning based on call analysis.</p>
                <form method="get" action="/api/v1/rag/reports/churn" id="churnForm">
                    <div class="mb-3">
                        <label class="form-label">Minimum Risk Score:</label>
                        <select name="min_score" class="form-select">
                            <option value="5">5+ (Medium & High)</option>
                            <option value="7" selected>7+ (High Risk)</option>
                            <option value="8">8+ (Critical)</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-danger" onclick="generateReport('churn')">
                        <i class="bi bi-file-earmark-text me-1"></i>Generate Report
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Agent Performance Report -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-person-badge me-2"></i>Agent Performance Report
            </div>
            <div class="card-body">
                <p>Analyze individual agent performance with coaching recommendations.</p>
                <form id="agentForm">
                    <div class="mb-3">
                        <label class="form-label">Agent Name:</label>
                        <select name="agent_name" class="form-select" required>
                            <option value="">Select an agent...</option>
                            {% for agent in agents %}
                            <option value="{{ agent }}">{{ agent }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date Range:</label>
                        <select name="date_range" class="form-select">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="this_week" selected>This Week</option>
                            <option value="this_month">This Month</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="generateAgentReport()">
                        <i class="bi bi-file-earmark-text me-1"></i>Generate Report
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Quality Analysis Report -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <i class="bi bi-star me-2"></i>Quality Analysis
            </div>
            <div class="card-body">
                <p>Analyze call quality trends and identify improvement areas.</p>
                <form id="qualityForm">
                    <div class="mb-3">
                        <label class="form-label">Focus Area:</label>
                        <select name="focus" class="form-select">
                            <option value="low_quality">Low Quality Calls (< 5)</option>
                            <option value="trends">Quality Trends Over Time</option>
                            <option value="by_type">Quality by Call Type</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-warning" onclick="generateQualityReport()">
                        <i class="bi bi-file-earmark-text me-1"></i>Generate Report
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Sentiment Analysis Report -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <i class="bi bi-emoji-smile me-2"></i>Sentiment Analysis
            </div>
            <div class="card-body">
                <p>Understand customer sentiment patterns and drivers.</p>
                <form id="sentimentForm">
                    <div class="mb-3">
                        <label class="form-label">Analysis Type:</label>
                        <select name="analysis" class="form-select">
                            <option value="negative">Negative Sentiment Drivers</option>
                            <option value="trends">Sentiment Trends</option>
                            <option value="by_agent">Sentiment by Agent</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-info" onclick="generateSentimentReport()">
                        <i class="bi bi-file-earmark-text me-1"></i>Generate Report
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Customer/Company Report -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <i class="bi bi-building me-2"></i>Customer Report
            </div>
            <div class="card-body">
                <p>Analyze all interactions with a specific customer company.</p>
                <form id="customerForm">
                    <div class="mb-3">
                        <label class="form-label">Customer Company:</label>
                        <select name="company_name" class="form-select" required>
                            <option value="">Select a company...</option>
                            {% for customer in customers %}
                            <option value="{{ customer.customer_company }}">{{ customer.customer_company }} ({{ customer.call_count }} calls)</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Or enter company name:</small>
                        <input type="text" name="custom_company" class="form-control mt-1" placeholder="Type company name...">
                    </div>
                    <button type="button" class="btn btn-success" onclick="generateCustomerReport()">
                        <i class="bi bi-file-earmark-text me-1"></i>Generate Report
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Report Output -->
<div class="card mt-4" id="reportOutput" style="display: none;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-file-text me-2"></i><span id="reportTitle">Report</span></span>
        <span class="badge bg-secondary" id="reportTime"></span>
    </div>
    <div class="card-body">
        <div class="response-box" id="reportContent"></div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div class="card" style="max-width: 400px; text-align: center;">
        <div class="card-body p-4">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5 class="mb-2">Generating Report...</h5>
            <p class="text-muted mb-3" id="loadingMessage">Querying database and analyzing data with AI. This may take 15-30 seconds.</p>
            <button type="button" class="btn btn-outline-secondary" onclick="cancelReport()">
                <i class="bi bi-x-circle me-1"></i>Cancel
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global abort controller for cancelling requests
let currentAbortController = null;

async function generateReport(type) {
    const form = document.getElementById(type + 'Form');
    const minScore = form.querySelector('[name="min_score"]').value;

    showLoading('Analyzing churn risk data...');

    try {
        currentAbortController = new AbortController();
        const response = await fetch(`/api/v1/rag/reports/churn?min_score=${minScore}`, {
            signal: currentAbortController.signal
        });

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();

        if (data.data && data.data.total_high_risk > 0) {
            showReport(`Churn Risk Report (${data.data.total_high_risk} high-risk customers)`, data.response);
        } else {
            showReport('Churn Risk Report', data.response || 'No high-risk customers found.');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            hideLoading();
            return;
        }
        showReport('Error', 'Failed to generate report: ' + error.message);
    }
}

async function generateAgentReport() {
    const form = document.getElementById('agentForm');
    const agentName = form.querySelector('[name="agent_name"]').value;
    const dateRange = form.querySelector('[name="date_range"]').value;

    if (!agentName) {
        alert('Please select an agent');
        return;
    }

    showLoading(`Analyzing performance data for ${agentName}...`);

    try {
        currentAbortController = new AbortController();
        let url = `/api/v1/rag/reports/agent/${encodeURIComponent(agentName)}`;
        if (dateRange) {
            url += `?date_range=${dateRange}`;
        }

        const response = await fetch(url, { signal: currentAbortController.signal });

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();

        if (data.metrics && data.metrics.total_calls > 0) {
            showReport(`Agent Report: ${data.agent} (${data.metrics.total_calls} calls)`, data.response);
        } else {
            showReport(`Agent Report: ${agentName}`, data.response || 'No calls found for this agent.');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            hideLoading();
            return;
        }
        showReport('Error', 'Failed to generate report: ' + error.message);
    }
}

async function generateQualityReport() {
    const form = document.getElementById('qualityForm');
    const focus = form.querySelector('[name="focus"]').value;

    showLoading('Analyzing call quality data...');

    try {
        currentAbortController = new AbortController();
        const response = await fetch(`/api/v1/rag/reports/quality?focus=${focus}`, {
            signal: currentAbortController.signal
        });

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}. Please restart the service.`);
        }

        const data = await response.json();

        if (data.data && data.data.total_low_quality > 0) {
            showReport(`Quality Analysis Report (${data.data.total_low_quality} low quality calls)`, data.response);
        } else {
            showReport('Quality Analysis Report', data.response || 'No low quality calls found.');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            hideLoading();
            return;
        }
        showReport('Error', 'Failed to generate report: ' + error.message);
    }
}

async function generateSentimentReport() {
    const form = document.getElementById('sentimentForm');
    const analysis = form.querySelector('[name="analysis"]').value;

    showLoading('Analyzing customer sentiment data...');

    try {
        currentAbortController = new AbortController();
        const response = await fetch(`/api/v1/rag/reports/sentiment?analysis=${analysis}`, {
            signal: currentAbortController.signal
        });

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}. Please restart the service.`);
        }

        const data = await response.json();

        if (data.data && data.data.total_matching > 0) {
            showReport(`Sentiment Analysis Report (${data.data.total_matching} calls analyzed)`, data.response);
        } else {
            showReport('Sentiment Analysis Report', data.response || 'No matching calls found.');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            hideLoading();
            return;
        }
        showReport('Error', 'Failed to generate report: ' + error.message);
    }
}

async function generateCustomerReport() {
    const form = document.getElementById('customerForm');
    const selectCompany = form.querySelector('[name="company_name"]').value;
    const customCompany = form.querySelector('[name="custom_company"]').value;

    const companyName = customCompany || selectCompany;

    if (!companyName) {
        alert('Please select or enter a company name');
        return;
    }

    showLoading(`Analyzing data for ${companyName}...`);

    try {
        currentAbortController = new AbortController();
        const response = await fetch(`/api/v1/rag/reports/customer/${encodeURIComponent(companyName)}`, {
            signal: currentAbortController.signal
        });

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();

        if (data.data && data.data.total_calls > 0) {
            showReport(`Customer Report: ${data.company} (${data.data.total_calls} calls)`, data.response);
        } else {
            showReport(`Customer Report: ${companyName}`, data.response || 'No calls found for this company.');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            hideLoading();
            return;
        }
        showReport('Error', 'Failed to generate report: ' + error.message);
    }
}

function showLoading(message) {
    document.getElementById('loadingMessage').textContent = message || 'Querying database and analyzing data with AI. This may take 15-30 seconds.';
    document.getElementById('loadingOverlay').style.display = 'flex';
    document.getElementById('reportOutput').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

function cancelReport() {
    if (currentAbortController) {
        currentAbortController.abort();
        currentAbortController = null;
    }
    hideLoading();
}

function showReport(title, content) {
    hideLoading();
    document.getElementById('reportOutput').style.display = 'block';
    document.getElementById('reportTitle').textContent = title;
    document.getElementById('reportContent').textContent = content;
    document.getElementById('reportTime').textContent = new Date().toLocaleString();

    // Scroll to report
    document.getElementById('reportOutput').scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}
