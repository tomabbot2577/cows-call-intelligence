{% extends "base.html" %}

{% block title %}{{ meeting.title[:50] }} - Video Meeting{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/video-meetings">Video Meetings</a></li>
                    <li class="breadcrumb-item active">{{ meeting.title[:40] }}...</li>
                </ol>
            </nav>
            <h2>{{ meeting.title }}</h2>
            <p class="text-muted">
                <span class="badge bg-primary">VIDEO MEETING</span>
                {{ meeting.start_time.strftime('%B %d, %Y at %I:%M %p') if meeting.start_time else 'Unknown date' }}
                | Host: {{ meeting.host_name or 'Unknown' }}
                | Duration: {{ ((meeting.duration_seconds or 0) / 60)|int }} minutes
            </p>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card">
                <div class="card-body text-center">
                    <h4 class="mb-0 {% if meeting.sentiment_score and meeting.sentiment_score >= 7 %}text-success{% elif meeting.sentiment_score and meeting.sentiment_score < 5 %}text-danger{% else %}text-warning{% endif %}">
                        {{ "%.1f"|format(meeting.sentiment_score or 0) }}
                    </h4>
                    <small class="text-muted">Sentiment</small>
                    <div><span class="badge {% if meeting.overall_sentiment == 'positive' %}bg-success{% elif meeting.overall_sentiment == 'negative' %}bg-danger{% else %}bg-secondary{% endif %}">{{ meeting.overall_sentiment or 'neutral' }}</span></div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body text-center">
                    <h4 class="mb-0 {% if meeting.meeting_quality_score and meeting.meeting_quality_score >= 8 %}text-success{% elif meeting.meeting_quality_score and meeting.meeting_quality_score < 6 %}text-danger{% else %}text-warning{% endif %}">
                        {{ "%.1f"|format(meeting.meeting_quality_score or 0) }}
                    </h4>
                    <small class="text-muted">Quality Score</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body text-center">
                    <h4 class="mb-0 text-info">{{ "%.1f"|format(meeting.learning_score or 0) }}</h4>
                    <small class="text-muted">Learning Score</small>
                    {% if meeting.learning_state %}
                    <div><span class="badge {% if meeting.learning_state == 'aha_zone' %}bg-success{% elif meeting.learning_state == 'struggling' %}bg-warning text-dark{% elif meeting.learning_state == 'overwhelmed' %}bg-danger{% else %}bg-info{% endif %}">{{ meeting.learning_state }}</span></div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body text-center">
                    <h4 class="mb-0">{{ meeting.participant_count or 0 }}</h4>
                    <small class="text-muted">Participants</small>
                    <div>
                        <span class="badge bg-primary">{{ meeting.internal_participant_count or 0 }} internal</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body text-center">
                    <h4 class="mb-0 {% if meeting.churn_risk_level == 'high' %}text-danger{% elif meeting.churn_risk_level == 'medium' %}text-warning{% else %}text-success{% endif %}">
                        {{ meeting.churn_risk_level or 'low' }}
                    </h4>
                    <small class="text-muted">Churn Risk</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body text-center">
                    <h4 class="mb-0">{{ meeting.qa_pairs|length }}</h4>
                    <small class="text-muted">Q&A Pairs</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Coaching Insights Card (Prominent) -->
    {% if meeting.ai_analysis_json %}
    {% set l6 = meeting.ai_analysis_json.get('layer6_learning', {}) %}
    {% set l4 = meeting.ai_analysis_json.get('layer4_recommendations', {}) %}
    {% set coaching = l6.get('coaching_recommendations', {}) %}
    {% set trainer_coaching = l4.get('trainer_coaching', {}) %}
    {% set teaching = l6.get('trainer_teaching_analysis', {}) %}

    <div class="card mb-4 border-success">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <span><i class="bi bi-trophy me-2"></i>Coaching Insights</span>
            <span class="badge bg-light text-dark">Joy-Focused Coaching</span>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Celebrate Wins (Strengths) -->
                <div class="col-md-4">
                    <h6 class="text-success"><i class="bi bi-star-fill me-1"></i>Celebrate Wins</h6>
                    <ul class="list-unstyled">
                        {% if trainer_coaching.get('strengths') %}
                            {% for s in trainer_coaching.strengths[:3] %}
                            <li class="mb-2"><i class="bi bi-check-circle text-success me-1"></i>{{ s }}</li>
                            {% endfor %}
                        {% elif l6.get('trainee_learning_profile') %}
                            <li class="mb-2"><i class="bi bi-check-circle text-success me-1"></i>Knowledge Level: {{ l6.trainee_learning_profile.get('knowledge_level', 'N/A') }}</li>
                            <li class="mb-2"><i class="bi bi-check-circle text-success me-1"></i>Learning Style: {{ l6.trainee_learning_profile.get('learning_style', 'N/A') }}</li>
                        {% else %}
                            <li class="text-muted">Analysis in progress...</li>
                        {% endif %}
                    </ul>
                    {% if teaching %}
                    <div class="mt-3">
                        <small class="text-muted">Teaching Scores:</small>
                        <div class="d-flex gap-2 mt-1">
                            {% if teaching.get('teaching_clarity') %}
                            <span class="badge {% if teaching.teaching_clarity >= 7 %}bg-success{% elif teaching.teaching_clarity >= 5 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                Clarity: {{ teaching.teaching_clarity }}/10
                            </span>
                            {% endif %}
                            {% if teaching.get('pacing_score') %}
                            <span class="badge {% if teaching.pacing_score >= 7 %}bg-success{% elif teaching.pacing_score >= 5 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                Pacing: {{ teaching.pacing_score }}/10
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Growth Opportunities -->
                <div class="col-md-4">
                    <h6 class="text-primary"><i class="bi bi-arrow-up-circle me-1"></i>Growth Opportunities</h6>
                    <ul class="list-unstyled">
                        {% set all_improvements = [] %}
                        {% if trainer_coaching.get('improvements') %}
                            {% for i in trainer_coaching.improvements[:2] %}
                            <li class="mb-2"><i class="bi bi-lightbulb text-warning me-1"></i>{{ i }}</li>
                            {% endfor %}
                        {% endif %}
                        {% if coaching.get('for_trainer') %}
                            {% for rec in coaching.for_trainer[:2] %}
                            <li class="mb-2"><i class="bi bi-lightbulb text-warning me-1"></i>{{ rec }}</li>
                            {% endfor %}
                        {% endif %}
                        {% if not trainer_coaching.get('improvements') and not coaching.get('for_trainer') %}
                            <li class="text-muted">No specific improvements identified</li>
                        {% endif %}
                    </ul>
                    {% if trainer_coaching.get('coaching_priorities') %}
                    <div class="mt-3">
                        <small class="text-muted">Priority Focus:</small>
                        {% for p in trainer_coaching.coaching_priorities[:2] %}
                        <div class="mt-1">
                            <span class="badge {% if p.priority == 'high' %}bg-danger{% else %}bg-warning text-dark{% endif %}">{{ p.area }}</span>
                            <small class="text-muted ms-1">{{ p.suggestion[:50] }}...</small>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- One Thing to Try Next -->
                <div class="col-md-4">
                    <h6 class="text-info"><i class="bi bi-bullseye me-1"></i>Next Session Focus</h6>
                    {% if coaching.get('for_trainee') %}
                    <div class="alert alert-info py-2 mb-2">
                        <strong>For Trainee:</strong>
                        <ul class="mb-0 ps-3">
                            {% for rec in coaching.for_trainee[:2] %}
                            <li class="small">{{ rec }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if l6.get('new_hire_readiness') %}
                    <div class="alert {% if l6.new_hire_readiness.status == 'ready' %}alert-success{% elif l6.new_hire_readiness.status == 'not_ready' %}alert-warning{% else %}alert-info{% endif %} py-2">
                        <strong>Readiness:</strong>
                        <span class="badge {% if l6.new_hire_readiness.status == 'ready' %}bg-success{% elif l6.new_hire_readiness.status == 'not_ready' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                            {{ l6.new_hire_readiness.status }}
                        </span>
                        {% if l6.new_hire_readiness.estimated_sessions_to_proficiency %}
                        <div class="small mt-1">Est. sessions to proficiency: {{ l6.new_hire_readiness.estimated_sessions_to_proficiency }}</div>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if meeting.ai_analysis_json.get('best_practices', {}).get('techniques_to_improve') %}
                    <div class="mt-2">
                        <small class="text-muted">Techniques to improve:</small>
                        {% for t in meeting.ai_analysis_json.best_practices.techniques_to_improve[:2] %}
                        <div class="small"><i class="bi bi-arrow-right text-primary"></i> {{ t.recommendation }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Left Column: Analysis -->
        <div class="col-md-8">
            <!-- Participants -->
            <div class="card mb-4">
                <div class="card-header">Participants ({{ meeting.participants|length }})</div>
                <div class="card-body p-0">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Company</th>
                                <th>Speaking %</th>
                                <th>Engagement</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in meeting.participants %}
                            <tr>
                                <td>
                                    {{ p.participant_name }}
                                    {% if p.is_trainer %}<span class="badge bg-primary">Trainer</span>{% endif %}
                                    {% if p.is_trainee %}<span class="badge bg-info">Trainee</span>{% endif %}
                                    {% if p.is_internal %}<span class="badge bg-secondary">Internal</span>{% endif %}
                                </td>
                                <td>{{ p.role_type or '-' }}</td>
                                <td>{{ p.company_name or '-' }}</td>
                                <td>
                                    {% if p.speaking_time_percentage %}
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" style="width: {{ p.speaking_time_percentage }}%">
                                            {{ p.speaking_time_percentage }}%
                                        </div>
                                    </div>
                                    {% else %}-{% endif %}
                                </td>
                                <td>
                                    {% if p.engagement_level %}
                                    <span class="badge {% if p.engagement_level == 'high' %}bg-success{% elif p.engagement_level == 'low' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                                        {{ p.engagement_level }}
                                    </span>
                                    {% else %}-{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Q&A Pairs -->
            {% if meeting.qa_pairs %}
            <div class="card mb-4">
                <div class="card-header">Knowledge Base Q&A Pairs</div>
                <div class="card-body">
                    {% for qa in meeting.qa_pairs %}
                    <div class="mb-3 p-3 bg-light rounded">
                        <div class="fw-bold text-primary mb-2">Q: {{ qa.question }}</div>
                        <div class="text-dark">A: {{ qa.answer }}</div>
                        {% if qa.category %}
                        <div class="mt-2"><span class="badge bg-secondary">{{ qa.category }}</span></div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- AI Analysis JSON (collapsible) -->
            {% if meeting.ai_analysis_json %}
            <div class="card mb-4">
                <div class="card-header">
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#analysisJson">
                        Full AI Analysis (click to expand)
                    </a>
                </div>
                <div class="collapse" id="analysisJson">
                    <div class="card-body">
                        <pre class="bg-dark text-light p-3 rounded" style="max-height: 500px; overflow-y: auto;">{{ meeting.ai_analysis_json | tojson(indent=2) }}</pre>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Transcript -->
            {% if meeting.transcript_text %}
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span>Transcript</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="copyTranscript()">Copy</button>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    <pre id="transcript" class="mb-0" style="white-space: pre-wrap;">{{ meeting.transcript_text }}</pre>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column: Sidebar -->
        <div class="col-md-4">
            <!-- Meeting Info -->
            <div class="card mb-4">
                <div class="card-header">Meeting Info</div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Type</dt>
                        <dd class="col-sm-8">{{ meeting.meeting_type or 'Unknown' }}</dd>

                        <dt class="col-sm-4">Host</dt>
                        <dd class="col-sm-8">{{ meeting.host_name }}<br><small class="text-muted">{{ meeting.host_email }}</small></dd>

                        <dt class="col-sm-4">Started</dt>
                        <dd class="col-sm-8">{{ meeting.start_time.strftime('%Y-%m-%d %H:%M') if meeting.start_time else 'N/A' }}</dd>

                        <dt class="col-sm-4">Duration</dt>
                        <dd class="col-sm-8">{{ ((meeting.duration_seconds or 0) / 60)|int }} minutes</dd>
                    </dl>
                </div>
            </div>

            <!-- Layer 6 Learning Analysis -->
            {% if meeting.ai_analysis_json and meeting.ai_analysis_json.layer6_learning %}
            {% set l6 = meeting.ai_analysis_json.layer6_learning %}
            <div class="card mb-4">
                <div class="card-header bg-info text-white">Layer 6: Learning Analysis</div>
                <div class="card-body">
                    {% if l6.utl_metrics %}
                    <h6>UTL Metrics</h6>
                    <ul class="list-unstyled">
                        <li>Learning Score: <strong>{{ l6.utl_metrics.learning_score }}</strong></li>
                        <li>Entropy Delta: {{ l6.utl_metrics.entropy_delta }}</li>
                        <li>Coherence Delta: {{ l6.utl_metrics.coherence_delta }}</li>
                        <li>Emotional Coeff: {{ l6.utl_metrics.emotional_coefficient }}</li>
                    </ul>
                    {% endif %}

                    {% if l6.learning_state %}
                    <h6>Learning State</h6>
                    <p>
                        <span class="badge {% if l6.learning_state.current_state == 'aha_zone' %}bg-success{% elif l6.learning_state.current_state == 'struggling' %}bg-warning text-dark{% else %}bg-info{% endif %} fs-6">
                            {{ l6.learning_state.current_state }}
                        </span>
                        <span class="badge bg-secondary">{{ l6.learning_state.trajectory }}</span>
                    </p>
                    {% endif %}

                    {% if l6.new_hire_readiness %}
                    <h6>Readiness Assessment</h6>
                    <p>
                        <span class="badge {% if l6.new_hire_readiness.status == 'ready' %}bg-success{% elif l6.new_hire_readiness.status == 'not_ready' %}bg-danger{% else %}bg-warning text-dark{% endif %} fs-6">
                            {{ l6.new_hire_readiness.status }}
                        </span>
                    </p>
                    {% if l6.new_hire_readiness.skill_gaps %}
                    <p class="text-muted small">Skill gaps: {{ l6.new_hire_readiness.skill_gaps | join(', ') }}</p>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Key Quotes -->
            {% if meeting.ai_analysis_json and meeting.ai_analysis_json.key_quotes %}
            <div class="card mb-4">
                <div class="card-header">Key Quotes</div>
                <div class="card-body">
                    {% for quote in meeting.ai_analysis_json.key_quotes[:5] %}
                    <blockquote class="blockquote fs-6 mb-3">
                        <p>"{{ quote.quote }}"</p>
                        <footer class="blockquote-footer">{{ quote.speaker }}
                            <span class="badge {% if quote.sentiment == 'positive' %}bg-success{% elif quote.sentiment == 'negative' %}bg-danger{% else %}bg-secondary{% endif %}">{{ quote.type }}</span>
                        </footer>
                    </blockquote>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Recommendations -->
            {% if meeting.ai_analysis_json and meeting.ai_analysis_json.layer4_recommendations %}
            {% set l4 = meeting.ai_analysis_json.layer4_recommendations %}
            <div class="card">
                <div class="card-header">Recommendations</div>
                <div class="card-body">
                    {% if l4.trainer_coaching and l4.trainer_coaching.improvements %}
                    <h6>Trainer Improvements</h6>
                    <ul class="small">
                        {% for i in l4.trainer_coaching.improvements[:3] %}
                        <li>{{ i }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}

                    {% if l4.process_improvements %}
                    <h6>Process Improvements</h6>
                    <ul class="small">
                        {% for p in l4.process_improvements[:3] %}
                        <li>{{ p.improvement }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function copyTranscript() {
    const text = document.getElementById('transcript').textContent;
    navigator.clipboard.writeText(text).then(() => {
        alert('Transcript copied to clipboard');
    });
}
</script>
{% endblock %}
