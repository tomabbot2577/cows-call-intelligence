{% extends "base.html" %}

{% block title %}{{ page_title }} - ConvoMetrics{% endblock %}

{% block extra_css %}
<style>
    .section-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #3498db;
    }

    .trigger-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: box-shadow 0.2s;
    }
    .trigger-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .trigger-card.inactive {
        opacity: 0.6;
        background: #f8f9fa;
    }

    .trigger-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .trigger-name {
        font-weight: 600;
        font-size: 1.1rem;
    }
    .trigger-type {
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        text-transform: uppercase;
    }
    .type-threshold_alert { background: #f8d7da; color: #721c24; }
    .type-below_expectations { background: #fff3cd; color: #856404; }
    .type-meets_expectations { background: #d4edda; color: #155724; }
    .type-exceeds_expectations { background: #d1ecf1; color: #0c5460; }
    .type-daily_summary { background: #e2e3e5; color: #383d41; }
    .type-weekly_summary { background: #cce5ff; color: #004085; }

    .trigger-meta {
        font-size: 0.875rem;
        color: #6c757d;
    }
    .trigger-actions {
        display: flex;
        gap: 0.5rem;
    }

    .status-active { color: #27ae60; }
    .status-inactive { color: #95a5a6; }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    .loading-overlay.hidden { display: none; }

    .condition-row {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        align-items: center;
    }
    .condition-row select, .condition-row input {
        flex: 1;
    }

    .history-table td {
        vertical-align: middle;
        font-size: 0.875rem;
    }
    .history-fired { color: #27ae60; }
    .history-skipped { color: #6c757d; }

    .test-result {
        padding: 0.5rem;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }
    .test-would-fire { background: #fff3cd; }
    .test-no-fire { background: #d4edda; }
</style>
{% endblock %}

{% block content %}
<div class="loading-overlay hidden" id="loadingOverlay">
    <div class="text-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3" id="loadingText">Loading...</p>
    </div>
</div>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">
                <i class="bi bi-bell"></i> Email Triggers
            </h1>
            <p class="text-muted mb-0">
                Configure automated email alerts based on dashboard metrics
            </p>
        </div>
        <div>
            <a href="/dashboard/admin" class="btn btn-outline-secondary me-2">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
            <button class="btn btn-primary" onclick="openCreateModal()">
                <i class="bi bi-plus-lg"></i> New Trigger
            </button>
        </div>
    </div>

    <!-- Triggers List -->
    <div class="section-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="section-title mb-0" style="border: none; padding: 0;">
                <i class="bi bi-list-check"></i> Active Triggers
            </h5>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="showInactive" onchange="loadTriggers()">
                <label class="form-check-label" for="showInactive">Show inactive</label>
            </div>
        </div>

        <div id="triggersContainer">
            <p class="text-muted">Loading triggers...</p>
        </div>
    </div>

    <!-- Execution History -->
    <div class="section-card">
        <h5 class="section-title"><i class="bi bi-clock-history"></i> Recent Trigger Activity</h5>
        <div class="table-responsive">
            <table class="table table-sm history-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Trigger</th>
                        <th>Employee</th>
                        <th>Result</th>
                        <th>Recipients</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <tr><td colspan="5" class="text-muted">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Help -->
    <div class="section-card">
        <h5 class="section-title"><i class="bi bi-question-circle"></i> Trigger Types</h5>
        <div class="row">
            <div class="col-md-4">
                <h6>Threshold Alert</h6>
                <p class="small text-muted">Fires when a metric crosses a specific value (e.g., answer rate &lt; 70%)</p>
            </div>
            <div class="col-md-4">
                <h6>Performance Alerts</h6>
                <p class="small text-muted">Below/Meets/Exceeds Expectations based on productivity scores</p>
            </div>
            <div class="col-md-4">
                <h6>Scheduled Summaries</h6>
                <p class="small text-muted">Daily or weekly reports sent at a specific time</p>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal fade" id="triggerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">
                    <i class="bi bi-plus-lg"></i> New Trigger
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="triggerForm" onsubmit="saveTrigger(event)">
                <div class="modal-body">
                    <input type="hidden" id="triggerId">

                    <!-- Basic Info -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label fw-bold">Trigger Name *</label>
                            <input type="text" class="form-control" id="triggerName" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Type *</label>
                            <select class="form-select" id="triggerType" required onchange="onTypeChange()">
                                <option value="threshold_alert">Threshold Alert</option>
                                <option value="below_expectations">Below Expectations</option>
                                <option value="meets_expectations">Meets Expectations</option>
                                <option value="exceeds_expectations">Exceeds Expectations</option>
                                <option value="daily_summary">Daily Summary</option>
                                <option value="weekly_summary">Weekly Summary</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" id="triggerDescription"
                               placeholder="Optional description">
                    </div>

                    <!-- Conditions -->
                    <div class="mb-3" id="conditionsSection">
                        <label class="form-label fw-bold">Conditions</label>
                        <div id="conditionsContainer"></div>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addCondition()">
                            <i class="bi bi-plus"></i> Add Condition
                        </button>
                        <div class="mt-2">
                            <label class="form-label small">Logic:</label>
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="radio" class="btn-check" name="conditionLogic" id="logicAnd" value="AND" checked>
                                <label class="btn btn-outline-secondary" for="logicAnd">All conditions (AND)</label>
                                <input type="radio" class="btn-check" name="conditionLogic" id="logicOr" value="OR">
                                <label class="btn btn-outline-secondary" for="logicOr">Any condition (OR)</label>
                            </div>
                        </div>
                    </div>

                    <!-- Applies To -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Applies To</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="appliesTo" id="appliesAll" value="all_users" checked onchange="toggleEmployeeSelect()">
                            <label class="form-check-label" for="appliesAll">All employees</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="appliesTo" id="appliesSpecific" value="specific_users" onchange="toggleEmployeeSelect()">
                            <label class="form-check-label" for="appliesSpecific">Specific employees</label>
                        </div>
                        <select class="form-select mt-2 hidden" id="targetEmployees" multiple size="5">
                            {% for emp in employees %}
                            <option value="{{ emp }}">{{ emp }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Schedule -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Frequency</label>
                            <select class="form-select" id="frequency" onchange="onFrequencyChange()">
                                <option value="realtime">Real-time (every 15 min)</option>
                                <option value="hourly">Hourly</option>
                                <option value="daily" selected>Daily</option>
                                <option value="weekly">Weekly</option>
                            </select>
                        </div>
                        <div class="col-md-4" id="scheduleTimeContainer">
                            <label class="form-label">Time</label>
                            <input type="time" class="form-control" id="scheduleTime" value="07:00">
                        </div>
                        <div class="col-md-4 hidden" id="scheduleDayContainer">
                            <label class="form-label">Day</label>
                            <select class="form-select" id="scheduleDay">
                                <option value="0">Monday</option>
                                <option value="1">Tuesday</option>
                                <option value="2">Wednesday</option>
                                <option value="3">Thursday</option>
                                <option value="4">Friday</option>
                                <option value="5">Saturday</option>
                                <option value="6">Sunday</option>
                            </select>
                        </div>
                    </div>

                    <!-- Notifications -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Notify</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notifyAdmin" checked>
                            <label class="form-check-label" for="notifyAdmin">Primary admin (sabbey@mainsequence.net)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notifyUser">
                            <label class="form-check-label" for="notifyUser">The employee (if they have an email)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notifyAllAdmins">
                            <label class="form-check-label" for="notifyAllAdmins">All admins</label>
                        </div>
                        <div class="mt-2">
                            <label class="form-label small">Additional emails (comma-separated):</label>
                            <input type="text" class="form-control" id="customEmails"
                                   placeholder="email1@example.com, email2@example.com">
                        </div>
                    </div>

                    <!-- Cooldown -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Cooldown</label>
                        <div class="input-group" style="max-width: 250px;">
                            <input type="number" class="form-control" id="cooldownMinutes" value="60" min="0">
                            <span class="input-group-text">minutes</span>
                        </div>
                        <small class="text-muted">Minimum time between trigger fires for the same employee</small>
                    </div>

                    <!-- Active -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="isActive" checked>
                        <label class="form-check-label fw-bold" for="isActive">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check"></i> Save Trigger
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Test Modal -->
<div class="modal fade" id="testModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-play"></i> Test Trigger</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="testTriggerName" class="fw-bold"></p>
                <div id="testResults">
                    <p class="text-muted">Running test...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let triggerModal, testModal;
    let allTriggers = [];

    const METRICS = [
        { value: 'answer_rate', label: 'Answer Rate (%)' },
        { value: 'total_calls', label: 'Total Calls' },
        { value: 'missed_calls', label: 'Missed Calls' },
        { value: 'avg_quality_score', label: 'Quality Score' },
        { value: 'productivity_score', label: 'Productivity Score' },
        { value: 'tickets_over_5_days', label: 'Overdue Tickets (>5d)' },
        { value: 'tickets_open_total', label: 'Open Tickets' },
        { value: 'escalation_count', label: 'Escalations' },
        { value: 'churn_risk_high_count', label: 'High Churn Risk Calls' }
    ];

    const OPERATORS = [
        { value: 'less_than', label: '<' },
        { value: 'less_than_or_equal', label: '<=' },
        { value: 'greater_than', label: '>' },
        { value: 'greater_than_or_equal', label: '>=' },
        { value: 'equals', label: '=' }
    ];

    document.addEventListener('DOMContentLoaded', function() {
        triggerModal = new bootstrap.Modal(document.getElementById('triggerModal'));
        testModal = new bootstrap.Modal(document.getElementById('testModal'));
        loadTriggers();
        loadHistory();
    });

    async function loadTriggers() {
        const showInactive = document.getElementById('showInactive').checked;
        const url = `/api/v1/triggers${showInactive ? '' : '?active_only=true'}`;

        try {
            const response = await fetch(url);
            const result = await response.json();

            if (result.success) {
                allTriggers = result.data;
                renderTriggers();
            }
        } catch (error) {
            console.error('Load triggers error:', error);
        }
    }

    function renderTriggers() {
        const container = document.getElementById('triggersContainer');

        if (allTriggers.length === 0) {
            container.innerHTML = '<p class="text-muted">No triggers configured. Click "New Trigger" to create one.</p>';
            return;
        }

        container.innerHTML = allTriggers.map(t => {
            const typeClass = `type-${t.trigger_type}`;
            const activeClass = t.is_active ? '' : 'inactive';
            const statusIcon = t.is_active
                ? '<i class="bi bi-check-circle-fill status-active"></i>'
                : '<i class="bi bi-pause-circle status-inactive"></i>';

            const lastTriggered = t.last_triggered_at
                ? new Date(t.last_triggered_at).toLocaleString()
                : 'Never';

            return `
                <div class="trigger-card ${activeClass}">
                    <div class="trigger-header">
                        <div>
                            ${statusIcon}
                            <span class="trigger-name">${t.name}</span>
                            <span class="trigger-type ${typeClass}">${t.trigger_type.replace(/_/g, ' ')}</span>
                        </div>
                        <div class="trigger-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="testTrigger(${t.id})" title="Test">
                                <i class="bi bi-play"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="editTrigger(${t.id})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTrigger(${t.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="trigger-meta">
                        <span><i class="bi bi-clock"></i> ${t.frequency}</span>
                        <span class="ms-3"><i class="bi bi-people"></i> ${t.applies_to === 'all_users' ? 'All users' : 'Specific users'}</span>
                        <span class="ms-3"><i class="bi bi-lightning"></i> Last: ${lastTriggered}</span>
                        ${t.description ? `<br><small class="text-muted">${t.description}</small>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    async function loadHistory() {
        try {
            const response = await fetch('/api/v1/triggers/history?limit=20');
            const result = await response.json();

            if (result.success) {
                const tbody = document.getElementById('historyTableBody');

                if (result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-muted">No trigger activity yet</td></tr>';
                    return;
                }

                tbody.innerHTML = result.data.map(h => {
                    const time = new Date(h.triggered_at).toLocaleString();
                    const resultClass = h.email_sent ? 'history-fired' : 'history-skipped';
                    const resultText = h.email_sent ? 'Email sent' : h.action_taken || 'Skipped';

                    return `
                        <tr>
                            <td>${time}</td>
                            <td>${h.trigger_name || '-'}</td>
                            <td>${h.employee_name || '-'}</td>
                            <td class="${resultClass}">${resultText}</td>
                            <td>${(h.recipients || []).join(', ') || '-'}</td>
                        </tr>
                    `;
                }).join('');
            }
        } catch (error) {
            console.error('Load history error:', error);
        }
    }

    function openCreateModal() {
        document.getElementById('triggerId').value = '';
        document.getElementById('modalTitle').innerHTML = '<i class="bi bi-plus-lg"></i> New Trigger';
        document.getElementById('triggerForm').reset();
        document.getElementById('conditionsContainer').innerHTML = '';
        addCondition();
        toggleEmployeeSelect();
        onFrequencyChange();
        triggerModal.show();
    }

    async function editTrigger(id) {
        showLoading(true, 'Loading trigger...');

        try {
            const response = await fetch(`/api/v1/triggers/${id}`);
            const result = await response.json();

            if (result.success) {
                const t = result.data;

                document.getElementById('triggerId').value = t.id;
                document.getElementById('modalTitle').innerHTML = '<i class="bi bi-pencil"></i> Edit Trigger';
                document.getElementById('triggerName').value = t.name || '';
                document.getElementById('triggerDescription').value = t.description || '';
                document.getElementById('triggerType').value = t.trigger_type || 'threshold_alert';
                document.getElementById('frequency').value = t.frequency || 'daily';

                // Applies to
                if (t.applies_to === 'specific_users') {
                    document.getElementById('appliesSpecific').checked = true;
                } else {
                    document.getElementById('appliesAll').checked = true;
                }
                toggleEmployeeSelect();

                if (t.target_employees) {
                    const select = document.getElementById('targetEmployees');
                    Array.from(select.options).forEach(opt => {
                        opt.selected = t.target_employees.includes(opt.value);
                    });
                }

                // Schedule
                if (t.schedule_time) {
                    document.getElementById('scheduleTime').value = t.schedule_time.substring(0, 5);
                }
                if (t.schedule_day !== null) {
                    document.getElementById('scheduleDay').value = t.schedule_day;
                }
                onFrequencyChange();

                // Notifications
                document.getElementById('notifyAdmin').checked = t.notify_admin;
                document.getElementById('notifyUser').checked = t.notify_user;
                document.getElementById('notifyAllAdmins').checked = t.notify_all_admins;
                document.getElementById('customEmails').value = (t.custom_emails || []).join(', ');

                // Cooldown
                document.getElementById('cooldownMinutes').value = t.cooldown_minutes || 60;

                // Active
                document.getElementById('isActive').checked = t.is_active;

                // Conditions
                document.getElementById('conditionsContainer').innerHTML = '';
                let conditions = t.conditions || {};
                if (conditions.conditions) conditions = conditions.conditions;
                if (!Array.isArray(conditions)) conditions = [conditions];

                conditions.forEach(c => {
                    if (c && c.metric) addCondition(c);
                });
                if (document.getElementById('conditionsContainer').innerHTML === '') {
                    addCondition();
                }

                document.getElementById(t.condition_logic === 'OR' ? 'logicOr' : 'logicAnd').checked = true;

                triggerModal.show();
            }
        } catch (error) {
            console.error('Edit trigger error:', error);
            alert('Failed to load trigger');
        } finally {
            showLoading(false);
        }
    }

    async function saveTrigger(event) {
        event.preventDefault();
        showLoading(true, 'Saving trigger...');

        try {
            const triggerId = document.getElementById('triggerId').value;
            const isEdit = !!triggerId;

            // Collect conditions
            const conditionRows = document.querySelectorAll('.condition-row');
            const conditions = [];
            conditionRows.forEach(row => {
                const metric = row.querySelector('.cond-metric').value;
                const operator = row.querySelector('.cond-operator').value;
                const value = parseFloat(row.querySelector('.cond-value').value);
                if (metric && !isNaN(value)) {
                    conditions.push({ metric, operator, value });
                }
            });

            // Collect target employees
            const appliesTo = document.querySelector('input[name="appliesTo"]:checked').value;
            let targetEmployees = null;
            if (appliesTo === 'specific_users') {
                const select = document.getElementById('targetEmployees');
                targetEmployees = Array.from(select.selectedOptions).map(opt => opt.value);
            }

            // Collect custom emails
            const customEmailsStr = document.getElementById('customEmails').value;
            const customEmails = customEmailsStr
                ? customEmailsStr.split(',').map(e => e.trim()).filter(e => e)
                : null;

            const data = {
                name: document.getElementById('triggerName').value,
                description: document.getElementById('triggerDescription').value || null,
                trigger_type: document.getElementById('triggerType').value,
                applies_to: appliesTo,
                target_employees: targetEmployees,
                conditions: { conditions },
                condition_logic: document.querySelector('input[name="conditionLogic"]:checked').value,
                frequency: document.getElementById('frequency').value,
                schedule_time: document.getElementById('scheduleTime').value + ':00',
                schedule_day: parseInt(document.getElementById('scheduleDay').value),
                notify_admin: document.getElementById('notifyAdmin').checked,
                notify_user: document.getElementById('notifyUser').checked,
                notify_all_admins: document.getElementById('notifyAllAdmins').checked,
                custom_emails: customEmails,
                cooldown_minutes: parseInt(document.getElementById('cooldownMinutes').value) || 60,
                is_active: document.getElementById('isActive').checked
            };

            const url = isEdit ? `/api/v1/triggers/${triggerId}` : '/api/v1/triggers';
            const method = isEdit ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                triggerModal.hide();
                loadTriggers();
            } else {
                throw new Error(result.message || 'Save failed');
            }

        } catch (error) {
            console.error('Save trigger error:', error);
            alert('Failed to save trigger: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    async function deleteTrigger(id) {
        if (!confirm('Are you sure you want to delete this trigger?')) return;

        showLoading(true, 'Deleting...');

        try {
            const response = await fetch(`/api/v1/triggers/${id}`, { method: 'DELETE' });
            const result = await response.json();

            if (result.success) {
                loadTriggers();
            } else {
                throw new Error(result.message || 'Delete failed');
            }
        } catch (error) {
            alert('Failed to delete trigger: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    async function testTrigger(id) {
        const trigger = allTriggers.find(t => t.id === id);
        document.getElementById('testTriggerName').textContent = trigger ? trigger.name : 'Trigger';
        document.getElementById('testResults').innerHTML = '<p class="text-muted">Running test...</p>';
        testModal.show();

        try {
            const response = await fetch(`/api/v1/triggers/${id}/test`, { method: 'POST' });
            const result = await response.json();

            if (result.success) {
                const html = result.test_results.map(r => {
                    const cls = r.would_fire ? 'test-would-fire' : 'test-no-fire';
                    const icon = r.would_fire ? '<i class="bi bi-exclamation-triangle"></i>' : '<i class="bi bi-check-circle"></i>';

                    return `
                        <div class="test-result ${cls}">
                            ${icon} <strong>${r.employee}</strong><br>
                            <small>
                                ${r.would_fire ? 'Would fire: ' + r.reason : 'Would not fire'}
                                <br>Answer: ${r.metrics_summary.answer_rate}% |
                                Quality: ${r.metrics_summary.quality_score} |
                                Score: ${r.metrics_summary.productivity_score}
                            </small>
                        </div>
                    `;
                }).join('');

                document.getElementById('testResults').innerHTML = html || '<p class="text-muted">No results</p>';
            } else {
                throw new Error(result.message || 'Test failed');
            }
        } catch (error) {
            document.getElementById('testResults').innerHTML =
                `<p class="text-danger">Error: ${error.message}</p>`;
        }
    }

    function addCondition(existing = null) {
        const container = document.getElementById('conditionsContainer');
        const row = document.createElement('div');
        row.className = 'condition-row';

        const metricOptions = METRICS.map(m =>
            `<option value="${m.value}" ${existing && existing.metric === m.value ? 'selected' : ''}>${m.label}</option>`
        ).join('');

        const opOptions = OPERATORS.map(o =>
            `<option value="${o.value}" ${existing && existing.operator === o.value ? 'selected' : ''}>${o.label}</option>`
        ).join('');

        row.innerHTML = `
            <select class="form-select cond-metric">${metricOptions}</select>
            <select class="form-select cond-operator" style="max-width: 80px;">${opOptions}</select>
            <input type="number" class="form-control cond-value" placeholder="Value" value="${existing ? existing.value : ''}" step="0.1">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">
                <i class="bi bi-x"></i>
            </button>
        `;

        container.appendChild(row);
    }

    function toggleEmployeeSelect() {
        const isSpecific = document.getElementById('appliesSpecific').checked;
        document.getElementById('targetEmployees').classList.toggle('hidden', !isSpecific);
    }

    function onFrequencyChange() {
        const freq = document.getElementById('frequency').value;
        const showTime = ['daily', 'weekly'].includes(freq);
        const showDay = freq === 'weekly';

        document.getElementById('scheduleTimeContainer').classList.toggle('hidden', !showTime);
        document.getElementById('scheduleDayContainer').classList.toggle('hidden', !showDay);
    }

    function onTypeChange() {
        const type = document.getElementById('triggerType').value;
        const showConditions = !['daily_summary', 'weekly_summary'].includes(type);
        document.getElementById('conditionsSection').classList.toggle('hidden', !showConditions);
    }

    function showLoading(show, text = 'Loading...') {
        document.getElementById('loadingText').textContent = text;
        document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
    }
</script>
{% endblock %}
