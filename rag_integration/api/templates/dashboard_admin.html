{% extends "base.html" %}

{% block title %}{{ page_title }} - COWS{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.25rem;
    }
    .metric-label {
        font-size: 0.875rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .metric-card.positive .metric-value { color: #27ae60; }
    .metric-card.warning .metric-value { color: #f39c12; }
    .metric-card.danger .metric-value { color: #e74c3c; }

    .section-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #3498db;
    }

    .period-btn {
        padding: 0.375rem 0.75rem;
        border: 1px solid #dee2e6;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .period-btn:hover { background: #f8f9fa; }
    .period-btn.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    .loading-overlay.hidden { display: none; }

    .team-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    .team-table th {
        background: #f8f9fa;
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        cursor: pointer;
        user-select: none;
    }
    .team-table th:hover { background: #e9ecef; }
    .team-table th[title] { cursor: help; }
    .team-table th[data-sort] { cursor: pointer; }
    .team-table th.sorted-asc::after { content: ' \25B2'; font-size: 0.7em; }
    .team-table th.sorted-desc::after { content: ' \25BC'; font-size: 0.7em; }
    .team-table td {
        padding: 0.75rem;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
    }
    .team-table tr:hover { background: #f8f9fa; }
    .team-table .employee-link {
        color: #3498db;
        text-decoration: none;
        font-weight: 500;
    }
    .team-table .employee-link:hover { text-decoration: underline; }

    .grade-badge {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-weight: 700;
        font-size: 0.875rem;
        min-width: 32px;
        text-align: center;
    }
    .grade-a { background: #d4edda; color: #155724; }
    .grade-b { background: #d1ecf1; color: #0c5460; }
    .grade-c { background: #fff3cd; color: #856404; }
    .grade-d { background: #ffeaa7; color: #856404; }
    .grade-f { background: #f8d7da; color: #721c24; }

    .row-grade-a { background: rgba(39, 174, 96, 0.05); }
    .row-grade-b { background: rgba(52, 152, 219, 0.05); }
    .row-grade-c { background: rgba(241, 196, 15, 0.05); }
    .row-grade-d { background: rgba(230, 126, 34, 0.05); }
    .row-grade-f { background: rgba(231, 76, 60, 0.05); }

    .text-positive { color: #27ae60; }
    .text-warning { color: #f39c12; }
    .text-danger { color: #e74c3c; }

    .search-input {
        max-width: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3">Loading team dashboard...</p>
    </div>
</div>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">
                <i class="bi bi-people-fill"></i> Team Dashboard
            </h1>
            <p class="text-muted mb-0">
                <span id="periodLabel">MTD</span> &bull;
                <span id="teamCount">-</span> active team members &bull;
                <span id="lastUpdated">Loading...</span>
            </p>
        </div>
        <div class="d-flex align-items-center gap-2">
            <!-- Period Selector -->
            <div class="btn-group" role="group">
                <button class="period-btn" data-period="today">Today</button>
                <button class="period-btn" data-period="wtd">WTD</button>
                <button class="period-btn" data-period="last_week">Last Week</button>
                <button class="period-btn active" data-period="mtd">MTD</button>
                <button class="period-btn" data-period="qtd">QTD</button>
                <button class="period-btn" data-period="ytd">YTD</button>
            </div>
            <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
            <button class="btn btn-outline-success" onclick="exportCSV()">
                <i class="bi bi-download"></i> Export
            </button>
        </div>
    </div>

    <!-- Team KPI Cards Row -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="metric-card">
                <div class="metric-value" id="totalTeamCalls">-</div>
                <div class="metric-label">Team Calls</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="metric-card" id="cardTeamAnswerRate">
                <div class="metric-value" id="avgAnswerRate">-%</div>
                <div class="metric-label">Avg Answer Rate</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="metric-card" id="cardTeamQuality">
                <div class="metric-value" id="avgQuality">-</div>
                <div class="metric-label">Avg Quality</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="metric-card">
                <div class="metric-value" id="totalTicketsClosed">-</div>
                <div class="metric-label">Tickets Closed</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="metric-card" id="cardOverdue">
                <div class="metric-value" id="totalOverdue">-</div>
                <div class="metric-label">Overdue Tickets</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="metric-card" id="cardAvgScore">
                <div class="metric-value" id="avgProductivity">-</div>
                <div class="metric-label">Avg Score</div>
            </div>
        </div>
    </div>

    <!-- Team Table -->
    <div class="section-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="section-title mb-0" style="border: none; padding: 0;">
                <i class="bi bi-table"></i> Team Performance
            </h5>
            <input type="text" class="form-control search-input" id="searchInput"
                   placeholder="Search employees..." oninput="filterTable()">
        </div>

        <div class="table-responsive">
            <table class="team-table" id="teamTable">
                <thead>
                    <tr>
                        <th data-sort="employee_name" title="Employee name - click to view details">Employee</th>
                        <th data-sort="total_calls" title="Total calls (inbound + outbound) for the period">Calls</th>
                        <th data-sort="inbound_calls" title="Inbound calls / Outbound calls">In/Out</th>
                        <th data-sort="avg_wait_time_seconds" title="Average time callers waited before the call was answered">Wait</th>
                        <th data-sort="calls_over_1_min_wait" title="Number of calls where caller waited more than 1 minute to be answered">>1m</th>
                        <th data-sort="voicemail_calls" title="Voicemails: Business Hours (8am-5pm) / After Hours (before 8am or after 5pm)">VM</th>
                        <th data-sort="tickets_opened" title="Support tickets opened/created during the period">Opened</th>
                        <th data-sort="tickets_closed" title="Support tickets closed/resolved during the period">Closed</th>
                        <th data-sort="tickets_over_5_days" title="Open tickets that are more than 5 days old (overdue)">>5d</th>
                        <th data-sort="productivity_score" title="Productivity score (0-100) based on calls, tickets, and quality metrics">Score</th>
                        <th data-sort="grade" title="Letter grade: A+ (97+), A (93+), A- (90+), B+ (87+), B (83+), B- (80+), C+ (77+), C (73+), C- (70+), D (60+), F (<60)">Grade</th>
                    </tr>
                </thead>
                <tbody id="teamTableBody">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="mt-3 text-muted small" id="tableFooter">
            Showing <span id="visibleCount">0</span> of <span id="totalCount">0</span> employees
        </div>
    </div>

    <!-- Admin Links -->
    <div class="row">
        <div class="col-md-6">
            <div class="section-card">
                <h5 class="section-title"><i class="bi bi-gear"></i> Admin Tools</h5>
                <div class="list-group list-group-flush">
                    <a href="/admin/agent-mapping" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-diagram-3"></i> Freshdesk Agent Mapping</span>
                        <span class="badge bg-secondary" id="unmappedCount">-</span>
                    </a>
                    <a href="/admin/triggers" class="list-group-item list-group-item-action">
                        <i class="bi bi-bell"></i> Email Triggers & Alerts
                    </a>
                    <a href="/admin/users" class="list-group-item list-group-item-action">
                        <i class="bi bi-people"></i> User Management
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="section-card">
                <h5 class="section-title"><i class="bi bi-bar-chart-line"></i> Quick Stats</h5>
                <table class="table table-sm mb-0">
                    <tr>
                        <td>Top Performer</td>
                        <td class="text-end fw-bold text-success" id="topPerformer">-</td>
                    </tr>
                    <tr>
                        <td>Needs Improvement</td>
                        <td class="text-end fw-bold text-danger" id="needsImprovement">-</td>
                    </tr>
                    <tr>
                        <td>Grade Distribution</td>
                        <td class="text-end" id="gradeDistribution">-</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPeriod = "mtd";
    let teamData = [];
    let currentSort = { column: 'productivity_score', direction: 'desc' };

    document.addEventListener('DOMContentLoaded', function() {
        // Period button handlers
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentPeriod = this.dataset.period;
                document.getElementById('periodLabel').textContent = this.textContent;
                loadDashboard();
            });
        });

        // Sort handlers
        document.querySelectorAll('.team-table th[data-sort]').forEach(th => {
            th.addEventListener('click', function() {
                const column = this.dataset.sort;
                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'desc';
                }
                renderTable();
                updateSortIndicators();
            });
        });

        loadDashboard();
        setInterval(loadDashboard, 5 * 60 * 1000);
    });

    function refreshDashboard() {
        loadDashboard();
    }

    async function loadDashboard() {
        showLoading(true);

        try {
            const response = await fetch(`/api/v1/dashboard/admin/team?period=${currentPeriod}`);
            if (!response.ok) throw new Error('Failed to load team data');

            const result = await response.json();
            if (result.success) {
                updateDashboard(result);
            }
        } catch (error) {
            console.error('Dashboard error:', error);
            alert('Failed to load dashboard: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    function updateDashboard(result) {
        const totals = result.team_totals;
        teamData = result.employees;

        // Update timestamp
        document.getElementById('lastUpdated').textContent =
            'Updated: ' + new Date().toLocaleTimeString();
        document.getElementById('teamCount').textContent = totals.total_employees;

        // Update KPI cards
        document.getElementById('totalTeamCalls').textContent = totals.total_calls;
        document.getElementById('avgAnswerRate').textContent = totals.avg_answer_rate + '%';
        document.getElementById('avgQuality').textContent = totals.avg_quality_score.toFixed(1);
        document.getElementById('totalTicketsClosed').textContent = totals.total_tickets_closed;
        document.getElementById('totalOverdue').textContent = totals.total_overdue;
        document.getElementById('avgProductivity').textContent = totals.avg_productivity_score;

        // Color code cards
        colorCard('cardTeamAnswerRate', totals.avg_answer_rate, [90, 75]);
        colorCard('cardTeamQuality', totals.avg_quality_score, [7, 5]);
        colorCard('cardOverdue', totals.total_overdue, [0, 5], true);
        colorCard('cardAvgScore', totals.avg_productivity_score, [80, 60]);

        // Find top and bottom performers
        if (teamData.length > 0) {
            const sorted = [...teamData].sort((a, b) =>
                b.productivity.score - a.productivity.score);
            document.getElementById('topPerformer').textContent =
                sorted[0].employee_name + ' (' + sorted[0].productivity.grade + ')';
            if (sorted.length > 1) {
                const bottom = sorted[sorted.length - 1];
                document.getElementById('needsImprovement').textContent =
                    bottom.employee_name + ' (' + bottom.productivity.grade + ')';
            }

            // Grade distribution
            const gradeCount = { A: 0, B: 0, C: 0, D: 0, F: 0 };
            teamData.forEach(m => {
                const g = m.productivity.grade.charAt(0).toUpperCase();
                if (gradeCount.hasOwnProperty(g)) gradeCount[g]++;
            });
            document.getElementById('gradeDistribution').innerHTML =
                `<span class="badge grade-a">${gradeCount.A}</span> ` +
                `<span class="badge grade-b">${gradeCount.B}</span> ` +
                `<span class="badge grade-c">${gradeCount.C}</span> ` +
                `<span class="badge grade-d">${gradeCount.D}</span> ` +
                `<span class="badge grade-f">${gradeCount.F}</span>`;
        }

        renderTable();
        updateSortIndicators();
        document.getElementById('totalCount').textContent = teamData.length;
    }

    function renderTable() {
        const tbody = document.getElementById('teamTableBody');
        const search = document.getElementById('searchInput').value.toLowerCase();

        // Filter
        let filtered = teamData.filter(m =>
            m.employee_name.toLowerCase().includes(search));

        // Sort
        filtered.sort((a, b) => {
            let aVal, bVal;
            const col = currentSort.column;

            switch (col) {
                case 'employee_name':
                    aVal = a.employee_name.toLowerCase();
                    bVal = b.employee_name.toLowerCase();
                    break;
                case 'total_calls':
                    aVal = a.calls.total_calls;
                    bVal = b.calls.total_calls;
                    break;
                case 'inbound_calls':
                    aVal = a.calls.inbound_calls;
                    bVal = b.calls.inbound_calls;
                    break;
                case 'avg_wait_time_seconds':
                    aVal = a.calls.avg_wait_time_seconds || 0;
                    bVal = b.calls.avg_wait_time_seconds || 0;
                    break;
                case 'calls_over_1_min_wait':
                    aVal = a.calls.calls_over_1_min_wait || 0;
                    bVal = b.calls.calls_over_1_min_wait || 0;
                    break;
                case 'voicemail_calls':
                    aVal = a.calls.voicemail_calls || 0;
                    bVal = b.calls.voicemail_calls || 0;
                    break;
                case 'tickets_opened':
                    aVal = a.tickets.tickets_opened;
                    bVal = b.tickets.tickets_opened;
                    break;
                case 'tickets_closed':
                    aVal = a.tickets.tickets_closed;
                    bVal = b.tickets.tickets_closed;
                    break;
                case 'tickets_open_total':
                    aVal = a.tickets.tickets_open_total;
                    bVal = b.tickets.tickets_open_total;
                    break;
                case 'tickets_over_5_days':
                    aVal = a.tickets.tickets_over_5_days;
                    bVal = b.tickets.tickets_over_5_days;
                    break;
                case 'productivity_score':
                    aVal = a.productivity.score;
                    bVal = b.productivity.score;
                    break;
                case 'grade':
                    aVal = a.productivity.grade;
                    bVal = b.productivity.grade;
                    break;
                default:
                    aVal = a.productivity.score;
                    bVal = b.productivity.score;
            }

            if (typeof aVal === 'string') {
                return currentSort.direction === 'asc'
                    ? aVal.localeCompare(bVal)
                    : bVal.localeCompare(aVal);
            }
            return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
        });

        // Render
        tbody.innerHTML = filtered.map(m => {
            const grade = m.productivity.grade.charAt(0).toLowerCase();
            const answerClass = m.calls.answer_rate >= 90 ? 'text-positive' :
                               m.calls.answer_rate >= 75 ? 'text-warning' : 'text-danger';
            const qualityClass = m.quality.avg_quality_score >= 7 ? 'text-positive' :
                                m.quality.avg_quality_score >= 5 ? 'text-warning' : 'text-danger';
            const overdueClass = m.tickets.tickets_over_5_days > 5 ? 'text-danger' :
                                m.tickets.tickets_over_5_days > 0 ? 'text-warning' : '';

            // Format wait time (seconds to "Xs" or "Xm Ys")
            const waitSecs = m.calls.avg_wait_time_seconds || 0;
            const waitFormatted = waitSecs < 60 ? Math.round(waitSecs) + 's' :
                                  Math.floor(waitSecs/60) + 'm ' + Math.round(waitSecs%60) + 's';
            const waitClass = waitSecs > 60 ? 'text-danger' : waitSecs > 30 ? 'text-warning' : '';

            // Voicemail split
            const vmBiz = m.calls.voicemail_business_hours || 0;
            const vmAfter = m.calls.voicemail_after_hours || 0;
            const vmTotal = m.calls.voicemail_calls || 0;

            return `
                <tr class="row-grade-${grade}">
                    <td>
                        <a href="/dashboard/admin/user/${encodeURIComponent(m.employee_name)}"
                           class="employee-link">${m.employee_name}</a>
                    </td>
                    <td><strong>${m.calls.total_calls}</strong></td>
                    <td><small class="text-primary">${m.calls.inbound_calls || 0}</small>/<small class="text-secondary">${m.calls.outbound_calls || 0}</small></td>
                    <td class="${waitClass}" title="Avg wait time to answer">${waitFormatted}</td>
                    <td class="${(m.calls.calls_over_1_min_wait || 0) > 0 ? 'text-warning' : ''}" title="Calls with >1 min wait">${m.calls.calls_over_1_min_wait || 0}</td>
                    <td title="Business Hours / After Hours"><small class="text-secondary">${vmBiz}</small>/<small class="text-muted">${vmAfter}</small></td>
                    <td>${m.tickets.tickets_opened}</td>
                    <td>${m.tickets.tickets_closed}</td>
                    <td class="${overdueClass}">${m.tickets.tickets_over_5_days}</td>
                    <td><strong>${m.productivity.score}</strong></td>
                    <td><span class="grade-badge grade-${grade}">${m.productivity.grade}</span></td>
                </tr>
            `;
        }).join('');

        document.getElementById('visibleCount').textContent = filtered.length;
    }

    function updateSortIndicators() {
        document.querySelectorAll('.team-table th').forEach(th => {
            th.classList.remove('sorted-asc', 'sorted-desc');
            if (th.dataset.sort === currentSort.column) {
                th.classList.add('sorted-' + currentSort.direction);
            }
        });
    }

    function filterTable() {
        renderTable();
    }

    function colorCard(cardId, value, thresholds, inverse = false) {
        const card = document.getElementById(cardId);
        card.className = 'metric-card';
        if (inverse) {
            if (value <= thresholds[0]) card.classList.add('positive');
            else if (value <= thresholds[1]) card.classList.add('warning');
            else card.classList.add('danger');
        } else {
            if (value >= thresholds[0]) card.classList.add('positive');
            else if (value >= thresholds[1]) card.classList.add('warning');
            else card.classList.add('danger');
        }
    }

    function formatDuration(seconds) {
        if (!seconds) return '-';
        const mins = Math.floor(seconds / 60);
        const secs = Math.round(seconds % 60);
        if (mins >= 60) {
            const hrs = Math.floor(mins / 60);
            return hrs + 'h ' + (mins % 60) + 'm';
        }
        return mins + 'm ' + secs + 's';
    }

    function showLoading(show) {
        document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
    }

    async function exportCSV() {
        try {
            const response = await fetch(`/api/v1/dashboard/admin/export?period=${currentPeriod}`);
            if (!response.ok) throw new Error('Export failed');

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `team_metrics_${currentPeriod}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
        } catch (error) {
            alert('Export failed: ' + error.message);
        }
    }
</script>
{% endblock %}
